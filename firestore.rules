rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // --- HELPER FUNCTIONS ---

    // 1. Authentication & User Data
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserData() {
      // Safely retrieve user document, return null if missing
      let userRes = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userRes != null ? userRes.data : null;
    }

    function isUserActive() {
      let userData = getUserData();
      let isExplicitAdmin = request.auth != null && (
        request.auth.uid == 'KHOxOqvfW9QRAvVdanb8UTpEMsl2' || 
        request.auth.uid == 'j9hrlnFKHYXQf54fuhVFV7Ywfnl2'
      );
      return isExplicitAdmin || (userData != null && userData.active == true);
    }

    // 2. Role Checks
    function hasRole(role) {
      let userData = getUserData();
      return userData != null && userData.role == role;
    }
    
    function isAdmin() {
      let userData = getUserData();
      let isExplicitAdmin = request.auth != null && (
        request.auth.uid == 'KHOxOqvfW9QRAvVdanb8UTpEMsl2' || 
        request.auth.uid == 'j9hrlnFKHYXQf54fuhVFV7Ywfnl2'
      );
      return isExplicitAdmin || (isAuthenticated() && userData != null && userData.role == 'admin' && userData.active == true);
    }

    function isManager() {
      return isAdmin() || (isUserActive() && hasRole('manager'));
    }
    
    // 3. Scope Checks (Outlet)
    // Checks if the user is allowed to access the specific outletId
    function hasOutletAccess(outletId) {
       let userData = getUserData();
       return isAdmin() || (isUserActive() && userData != null && userData.allowedOutlets != null && outletId in userData.allowedOutlets);
    }

    // 4. Data Validation Helpers
    function isStringsList(list) {
      return list is list && (list.size() == 0 || list[0] is string);
    }

    // --- COLLECTION RULES ---

    // 1. Users Collection (Profile)
    match /users/{uid} {
      // User can read their own profile
      allow read: if isAuthenticated() && (request.auth.uid == uid || isAdmin());
      
      // Onboarding: User can create ONLY their own doc if it doesn't exist
      // Must set safe defaults (viewer, active: false)
      allow create: if isAuthenticated() && request.auth.uid == uid &&
        request.resource.data.role == 'viewer' &&
        request.resource.data.active == false &&
        request.resource.data.allowedOutlets.size() == 0;
        
      // Update: User can update non-critical fields (name, email)
      // CANNOT update: role, active, allowedOutlets, defaultOutletId
      allow update: if isAuthenticated() && request.auth.uid == uid &&
        request.resource.data.role == resource.data.role &&
        request.resource.data.active == resource.data.active &&
        request.resource.data.allowedOutlets == resource.data.allowedOutlets &&
        request.resource.data.defaultOutletId == resource.data.defaultOutletId;

      // Admin can do anything
      allow write: if isAdmin();
    }

    // 2. Global Collections (No OutletId Scoping)
    match /suppliers/{supplierId} {
      allow read: if isAuthenticated() && isUserActive();
      allow write: if isManager(); // Only Admin/Manager can manage Global Suppliers
    }
    
    match /outlets/{outletId} {
      allow read: if isAuthenticated() && isUserActive();
      allow write: if isAdmin(); // Only Admin creates outlets
    }

    // 3. Scoped Collections (OutletId Mandatory)
    
    // Helper for Common Scoped Resource
    function isScopedWrite(rsrc) {
       return hasOutletAccess(rsrc.data.outletId);
    }

    function isScopedDelete() {
       return hasOutletAccess(resource.data.outletId);
    }

    // Ingredients (Inventory)
    match /ingredients/{id} {
      allow read: if isAuthenticated() && hasOutletAccess(resource.data.outletId);
      allow create: if isAuthenticated() && isScopedWrite(request.resource) &&
                    (hasRole('chef') || hasRole('storekeeper') || isManager());
      allow update: if isAuthenticated() && hasOutletAccess(resource.data.outletId) &&
                    isScopedWrite(request.resource) &&
                    request.resource.data.outletId == resource.data.outletId &&
                    (hasRole('chef') || hasRole('storekeeper') || isManager());
      allow delete: if isManager() && isScopedDelete();
    }

    // Recipes & Menus (Chef Domain)
    match /recipes/{id} {
      allow read: if isAuthenticated() && hasOutletAccess(resource.data.outletId);
      allow create: if isAuthenticated() && isScopedWrite(request.resource) &&
                    (hasRole('chef') || isManager());
      allow update: if isAuthenticated() && hasOutletAccess(resource.data.outletId) &&
                    isScopedWrite(request.resource) &&
                    request.resource.data.outletId == resource.data.outletId &&
                    (hasRole('chef') || isManager());
      allow delete: if isAuthenticated() && isScopedDelete() &&
                    (hasRole('chef') || isManager());
    }

    match /menus/{id} {
      allow read: if isAuthenticated() && hasOutletAccess(resource.data.outletId);
      allow create: if isAuthenticated() && isScopedWrite(request.resource) &&
                    (hasRole('chef') || isManager());
      allow update: if isAuthenticated() && hasOutletAccess(resource.data.outletId) &&
                    isScopedWrite(request.resource) &&
                    request.resource.data.outletId == resource.data.outletId &&
                    (hasRole('chef') || isManager());
      allow delete: if isAuthenticated() && isScopedDelete() &&
                    (hasRole('chef') || isManager());
    }

    // Events (Manager/Chef)
    match /events/{id} {
      allow read: if isAuthenticated() && hasOutletAccess(resource.data.outletId);
      allow create: if isAuthenticated() && isScopedWrite(request.resource) &&
                    (hasRole('chef') || isManager());
      allow update: if isAuthenticated() && hasOutletAccess(resource.data.outletId) &&
                    isScopedWrite(request.resource) &&
                    request.resource.data.outletId == resource.data.outletId &&
                    (hasRole('chef') || isManager());
      allow delete: if isAuthenticated() && isScopedDelete() &&
                    (hasRole('chef') || isManager());
    }

    // Purchasing (Storekeeper Domain)
    match /purchaseOrders/{id} {
      allow read: if isAuthenticated() && hasOutletAccess(resource.data.outletId);
      allow create: if isAuthenticated() && isScopedWrite(request.resource) &&
                    (hasRole('storekeeper') || hasRole('chef') || isManager());
      allow update: if isAuthenticated() && hasOutletAccess(resource.data.outletId) &&
                    isScopedWrite(request.resource) &&
                    request.resource.data.outletId == resource.data.outletId &&
                    (hasRole('storekeeper') || hasRole('chef') || isManager());
      allow delete: if isManager() && isScopedDelete();
    }

    // Other Scoped
    match /wasteRecords/{id} {
      allow read: if isAuthenticated() && hasOutletAccess(resource.data.outletId);
      allow create: if isAuthenticated() && isScopedWrite(request.resource) &&
                    (hasRole('chef') || hasRole('storekeeper') || isManager());
      allow update: if isAuthenticated() && hasOutletAccess(resource.data.outletId) &&
                    isScopedWrite(request.resource) &&
                    request.resource.data.outletId == resource.data.outletId &&
                    (hasRole('chef') || hasRole('storekeeper') || isManager());
      allow delete: if isAuthenticated() && isScopedDelete() &&
                    (hasRole('chef') || hasRole('storekeeper') || isManager());
    }

    match /staff/{id} {
       // Staff is usually managed by Admin/Manager
       allow read: if isAuthenticated() && hasOutletAccess(resource.data.outletId);
       allow create: if isManager() && isScopedWrite(request.resource);
       allow update: if isManager() && hasOutletAccess(resource.data.outletId) &&
                     isScopedWrite(request.resource) &&
                     request.resource.data.outletId == resource.data.outletId;
       allow delete: if isManager() && isScopedDelete();
    }

    match /schedule/{id} {
       allow read: if isAuthenticated() && hasOutletAccess(resource.data.outletId);
       allow create: if (isManager() || hasRole('chef')) && isScopedWrite(request.resource);
       allow update: if (isManager() || hasRole('chef')) && hasOutletAccess(resource.data.outletId) &&
                     isScopedWrite(request.resource) &&
                     request.resource.data.outletId == resource.data.outletId;
       allow delete: if (isManager() || hasRole('chef')) && isScopedDelete();
    }

    // Production Tasks
    match /productionTasks/{id} {
      // Production tasks are scoped by outletId in useProductionSync.ts
      allow read: if isAuthenticated() && hasOutletAccess(resource.data.outletId);
      allow create: if isAuthenticated() && isScopedWrite(request.resource) &&
                   (hasRole('chef') || isManager());
      allow update: if isAuthenticated() && hasOutletAccess(resource.data.outletId) &&
                    isScopedWrite(request.resource) &&
                    request.resource.data.outletId == resource.data.outletId &&
                    (hasRole('chef') || isManager());
      allow delete: if isAuthenticated() && isScopedDelete() &&
                    (hasRole('chef') || isManager());
    }

    // HACCP & PCCs

    // PCCs seem to be global or unscoped in current code (missing outletId in type)
    // We'll allow authenticated read, manager write for now.
    match /pccs/{id} {
      allow read: if isAuthenticated() && isUserActive();
      allow write: if isManager();
    }

    // HACCP Logs
    // These link to PCC and User. No direct outlet link, but logically part of operations.
    // Allow any auth user to create logs (staff doing checks).
    // Allow read for auth users (monitoring).
    match /haccpLogs/{id} {
       allow read: if isAuthenticated() && isUserActive();
       allow create: if isAuthenticated() && isUserActive();
       allow update: if isManager(); // Only managers should edit logs? Or maybe nobody.
       allow delete: if isManager();
    }

    // HACCP Tasks (Definitions)
    match /haccpTasks/{id} {
       allow read: if isAuthenticated() && isUserActive();
       allow write: if isManager();
    }

    // HACCP Completions
    match /haccpTaskCompletions/{id} {
       allow read: if isAuthenticated() && isUserActive();
       allow create: if isAuthenticated() && isUserActive();
       allow update: if isManager();
    }

    // Notifications
    // Currently used as a broadcast or personal inbox.
    // Allowing auth users to read/write for now to support the feature.
    match /notifications/{id} {
      allow read: if isAuthenticated() && isUserActive();
      // Allow create/update for system/users marking read
      allow write: if isAuthenticated() && isUserActive();
    }

    // Batches (Inventory Lots) - NEW
    match /batches/{id} {
      allow read: if isAuthenticated() && hasOutletAccess(resource.data.outletId);
      allow create: if isAuthenticated() && isScopedWrite(request.resource) &&
                    (hasRole('storekeeper') || hasRole('chef') || isManager());
      allow update: if isAuthenticated() && hasOutletAccess(resource.data.outletId) &&
                    isScopedWrite(request.resource) &&
                    request.resource.data.outletId == resource.data.outletId &&
                    (hasRole('storekeeper') || hasRole('chef') || isManager());
      allow delete: if isManager() && isScopedDelete();
    }

    // Fichas TÃ©cnicas (Professional Recipes & Costs) - NEW
    match /fichasTecnicas/{id} {
      allow read: if isAuthenticated() && hasOutletAccess(resource.data.outletId);
      allow create: if isAuthenticated() && isScopedWrite(request.resource) &&
                    (hasRole('chef') || isManager());
      allow update: if isAuthenticated() && hasOutletAccess(resource.data.outletId) &&
                    isScopedWrite(request.resource) &&
                    request.resource.data.outletId == resource.data.outletId &&
                    (hasRole('chef') || isManager());
      allow delete: if isManager() && isScopedDelete();
    }

    match /versionesFichas/{id} {
      allow read: if isAuthenticated() && hasOutletAccess(resource.data.outletId);
      allow create: if isAuthenticated() && isScopedWrite(request.resource) &&
                    (hasRole('chef') || isManager());
      allow update: if false; // Versions are immutable snapshots
      allow delete: if isManager() && isScopedDelete();
    }
  }
}
